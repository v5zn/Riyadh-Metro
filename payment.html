<!DOCTYPE html>
<html>
<head>
    <title>Riyadh Metro - Payment</title>
    <link rel="icon" href="Pics/1..png">
    <link rel="stylesheet" href="RiyadhMetro.css">
    <style>
        .payment-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .ticket-details {
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .ticket-selection select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin: 15px 0;
        }

        .ticket-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .payment-methods {
            margin: 30px 0;
        }

        .methods-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 15px;
        }

        .payment-method {
            position: relative;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .payment-method img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }

        .payment-method:hover {
            border-color: #21a953;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(33, 169, 83, 0.2);
        }

        .payment-method.selected {
            border-color: #21a953;
            background: #f0fff4;
        }

        .payment-method.selected img {
            transform: scale(1.1);
        }

        .payment-method p {
            font-size: 16px;
            font-weight: 500;
            margin: 0;
            color: #333;
        }

        #payment-forms {
            opacity: 0;
            height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        #payment-forms.visible {
            opacity: 1;
            height: auto;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .card-input-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25) !important;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        .ticket-change {
            margin: 15px 0;
        }

        .ticket-change select {
            padding: 8px;
            margin-left: 10px;
            border-radius: 5px;
        }

        .total-price {
            font-size: 18px;
            margin: 15px 0;
            color: #072211;
        }
        #payment-forms {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        #payment-forms.visible {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .payment-method {
            position: relative;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 5px;
            right: 5px;
            color: #21a953;
            font-size: 20px;
        }
        .pay-button {
            width: 100%;
            padding: 20px;
            background: #21a953;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .pay-button:hover {
            background: #188740;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .pay-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        #card-form {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        #card-form.visible {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .payment-method {
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method.selected {
            border-color: #21a953;
            background: #f0fff4;
        }

        .card-error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .card-error.visible {
            display: block;
        }

       
        .card-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .card-modal-content {
            background: white;
            width: 90%;
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideDown 0.3s;
        }

        .card-form-group {
            margin-bottom: 20px;
        }

        .card-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .card-form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .card-form-group input:focus {
            border-color: #21a953;
            outline: none;
        }

        .card-details-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .error-text {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

       
        #cardDetailsForm {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .card-input:focus {
            border-color: #21a953;
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 169, 83, 0.2);
        }

        
        #cardDetailsForm {
            display: none;
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .card-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .card-input:focus {
            border-color: #21a953;
            outline: none;
        }

        .card-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div id="head">
        <a href="tickets.html"><button class="buttons">Tickets</button></a>
        <a href="line.html"><button class="buttons">Lines</button></a>
        <a href="Paths.html"><button class="buttons">Paths</button></a>
        <a href="About.html"><button class="buttons">About</button></a>
        <a href="Contact.html"><button class="buttons">Contact</button></a>
        
        <div class="dropdown">
            <button class="dropbtn">Menu</button>
            <div class="dropdown-content">
                <a href="tickets.html">Tickets</a>
                <a href="line.html">Lines</a>
                <a href="Paths.html">Paths</a>
                <a href="About.html">About</a>
                <a href="Contact.html">Contact</a>
            </div>
        </div>
        <div id="Pic">
            <a href="index.html"><img src="Pics/drb.png" style="height: 100px;"></a>
            <img src="Pics/unii.png" alt="Static Image" style="height: 100px;">
        </div>
    </div>

    <div class="payment-container">
        <div class="ticket-details">
            <h2>Ticket Details</h2>
            <div class="ticket-selection">
                <label for="ticket-select">Select Ticket Type:</label>
                <select id="ticket-select" onchange="updateTicketDetails()">
                   
                </select>
            </div>
            <div class="ticket-info">
                <p>Type: <span id="ticket-type"></span></p>
                <p>Duration: <span id="ticket-duration"></span></p>
                <p>Price: <span id="ticket-price"></span> SAR</p>
            </div>
        </div>

        <div class="payment-methods">
            <h3>Select Payment Method</h3>
            <div class="methods-grid">
                <div class="payment-method" data-method="card" onclick="selectPaymentMethod('card')">
                    <img src="Pics/card.png" alt="Credit Card">
                    <p>Credit Card</p>
                </div>
                <div class="payment-method" data-method="apple" onclick="selectPaymentMethod('apple')">
                    <img src="Pics/apple-pay.png" alt="Apple Pay">
                    <p>Apple Pay</p>
                </div>
                <div class="payment-method" data-method="stc" onclick="selectPaymentMethod('stc')">
                    <img src="Pics/stc-pay.png" alt="STC Pay">
                    <p>STC Pay</p>
                </div>
            </div>

          
            <div id="cardDetailsForm" style="display: none;">
                <div class="form-group">
                    <input type="text" 
                           class="card-input" 
                           id="card-number" 
                           placeholder="Card Number" 
                           maxlength="16" 
                           required>
                    <span class="error-message">Please enter a valid card number</span>
                </div>
                <div class="card-details-grid">
                    <div class="form-group">
                        <input type="text" 
                               class="card-input" 
                               id="card-expiry" 
                               placeholder="MM/YY" 
                               maxlength="5" 
                               required>
                        <span class="error-message">Please enter a valid expiry date</span>
                    </div>
                    <div class="form-group">
                        <input type="text" 
                               class="card-input" 
                               id="card-cvv" 
                               placeholder="CVV" 
                               maxlength="3" 
                               required>
                        <span class="error-message">Please enter a valid CVV</span>
                    </div>
                </div>
                <div class="form-group">
                    <input type="text" 
                           class="card-input" 
                           id="card-name" 
                           placeholder="Card Holder Name" 
                           required>
                    <span class="error-message">Please enter the card holder name</span>
                </div>
            </div>
        </div>

        <button onclick="processPayment()" class="pay-button" id="pay-button">
            Pay <span id="button-price"></span> SAR
        </button>
    </div>


    <div id="cardModal" class="card-modal">
        <div class="card-modal-content">
            <h2>Enter Card Details</h2>
            <form id="cardForm" onsubmit="return validateAndPay(event)">
                <div class="card-form-group">
                    <label for="cardNumber">Card Number</label>
                    <input type="text" id="cardNumber" maxlength="16" placeholder="1234 5678 9012 3456" required>
                    <span class="error-text">Please enter a valid card number</span>
                </div>
                <div class="card-details-row">
                    <div class="card-form-group">
                        <label for="expiryDate">Expiry Date</label>
                        <input type="text" id="expiryDate" maxlength="5" placeholder="MM/YY" required>
                        <span class="error-text">Please enter a valid date</span>
                    </div>
                    <div class="card-form-group">
                        <label for="cvv">CVV</label>
                        <input type="text" id="cvv" maxlength="3" placeholder="123" required>
                        <span class="error-text">Please enter a valid CVV</span>
                    </div>
                </div>
                <div class="card-form-group">
                    <label for="cardName">Card Holder Name</label>
                    <input type="text" id="cardName" placeholder="Name on card" required>
                    <span class="error-text">Please enter the card holder name</span>
                </div>
                <button type="submit" class="pay-button">
                    Pay <span id="modal-price">0</span> SAR
                </button>
                <button type="button" class="cancel-button" onclick="closeCardModal()">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        function updateTicketDetails() {
            const select = document.getElementById('ticket-select');
            const option = select.options[select.selectedIndex];
            
            const type = option.value;
            const price = option.dataset.price;
            const duration = option.dataset.duration;
            
            document.getElementById('ticket-type').textContent = type;
            document.getElementById('ticket-duration').textContent = duration;
            document.getElementById('ticket-price').textContent = price;
            document.getElementById('button-price').textContent = price;

           
            const ticketData = {
                type: type,
                price: parseInt(price),
                duration: duration
            };
            localStorage.setItem('selectedTicket', JSON.stringify(ticketData));
        }

        function showCardModal() {
            const modal = document.getElementById('cardModal');
            const price = document.getElementById('ticket-price').textContent;
            document.getElementById('modal-price').textContent = price;
            modal.style.display = 'block';
        }

        function closeCardModal() {
            document.getElementById('cardModal').style.display = 'none';
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
        }

        function validateAndPay(event) {
            event.preventDefault();
            
            const cardNumber = document.getElementById('cardNumber').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const cvv = document.getElementById('cvv').value;
            const cardName = document.getElementById('cardName').value;

            
            if (!validateCardNumber(cardNumber) || 
                !validateExpiryDate(expiryDate) || 
                !validateCVV(cvv) || 
                !cardName.trim()) {
                return false;
            }

            
            processPayment();
            closeCardModal();
            return false;
        }

      
        function validateCardNumber(number) {
            return /^[0-9]{16}$/.test(number.replace(/\s/g, ''));
        }

        function validateExpiryDate(date) {
            return /^(0[1-9]|1[0-2])\/([0-9]{2})$/.test(date);
        }

        function validateCVV(cvv) {
            return /^[0-9]{3,4}$/.test(cvv);
        }

       
        document.addEventListener('DOMContentLoaded', function() {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
        alert('Please login first');
        window.location.href = 'login.html';
        return;
    }

    const savedTicket = JSON.parse(localStorage.getItem('selectedTicket'));
    if (!savedTicket) {
        window.location.href = 'tickets.html';
        return;
    }

   
    fetch('http://localhost:3000/ticket-prices')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('ticket-select');
                select.innerHTML = '';
                
                data.prices.forEach(ticket => {
                    const option = document.createElement('option');
                    option.value = ticket.type;
                    option.dataset.price = ticket.price;
                    option.dataset.duration = ticket.duration;
                    option.textContent = `${ticket.type} - ${ticket.price} SAR`;
                    
                    
                    if (savedTicket && savedTicket.type === ticket.type) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

               
                if (select.selectedIndex === -1 && select.options.length > 0) {
                    
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].value === savedTicket.type) {
                            select.selectedIndex = i;
                            break;
                        }
                    }
                }
                updateTicketDetails();
            }
        })
        .catch(error => {
            console.error('Error loading prices:', error);
            window.location.href = 'tickets.html';
        });
});


        let selectedMethod = 'card';
        function selectPaymentMethod(method) {
           
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            selectedMethod = method; 
            
          
            const selectedElement = document.querySelector(`[data-method="${method}"]`);
            selectedElement.classList.add('selected');

          
            const cardDetailsForm = document.getElementById('cardDetailsForm');
            if (method === 'card') {
                cardDetailsForm.style.display = 'block';
                cardDetailsForm.style.opacity = '0';
                requestAnimationFrame(() => {
                    cardDetailsForm.style.opacity = '1';
                });
            } else {
                cardDetailsForm.style.display = 'none';
            }
        }

        function validateCardForm() {
            const cardNumber = document.getElementById('card-number');
            const cardExpiry = document.getElementById('card-expiry');
            const cardCvv = document.getElementById('card-cvv');
            const cardName = document.getElementById('card-name');
            let isValid = true;

           
            if (!cardNumber.value.match(/^[0-9]{16}$/)) {
                showError(cardNumber);
                isValid = false;
            }

         
            if (!cardExpiry.value.match(/^(0[1-9]|1[0-2])\/([0-9]{2})$/)) {
                showError(cardExpiry);
                isValid = false;
            }

          
            if (!cardCvv.value.match(/^[0-9]{3,4}$/)) {
                showError(cardCvv);
                isValid = false;
            }

           
            if (cardName.value.trim() === '') {
                showError(cardName);
                isValid = false;
            }

            return isValid;
        }

        function showError(element) {
            element.classList.add('card-input-error');
            element.nextElementSibling.classList.add('visible');
        }

        function clearErrors() {
            document.querySelectorAll('.card-input-error').forEach(el => {
                el.classList.remove('card-input-error');
            });
            document.querySelectorAll('.error-message').forEach(el => {
                el.classList.remove('visible');
            });
        }

        function processPayment() {
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user) {
                alert("Please login first!");
                window.location.href = "login.html";
                return;
            }

            const ticketData = {
                userId: user.id,
                type: document.getElementById("ticket-type").textContent,
                price: document.getElementById("ticket-price").textContent,
                duration: document.getElementById("ticket-duration").textContent
            };

            fetch("http://localhost:3000/purchase-ticket", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(ticketData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Purchase successful! Your ticket is now active.");
                    window.location.href = "index.html#active-tickets";
                } else {
                    alert("Purchase failed. Please try again.");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred during payment. Please try again.");
            });
        }

        function validateCardForm() {
            if (!document.querySelector('.payment-method.selected')) {
                alert('Please select a payment method');
                return false;
            }

            const selectedMethod = document.querySelector('.payment-method.selected').dataset.method;
            if (selectedMethod === 'card') {
                const cardNumber = document.getElementById('card-number').value;
                const cardExpiry = document.getElementById('card-expiry').value;
                const cardCvv = document.getElementById('card-cvv').value;

                if (!cardNumber || !cardExpiry || !cardCvv) {
                    alert('Please fill in all card details');
                    return false;
                }
            }
            return true;
        }

        function processPayment() {
            if (!validateCardForm()) {
                return;
            }
            
            
        }

        function processPayment() {
                 if (!selectedMethod) {
                alert("Please select a payment method");
                return;
            }

          
            if (selectedMethod === 'card') {
                const cardNumber = document.getElementById('card-number').value;
                const cardExpiry = document.getElementById('card-expiry').value;
                const cardCvv = document.getElementById('card-cvv').value;
                const cardName = document.getElementById('card-name').value;

                if (!cardNumber || !cardExpiry || !cardCvv || !cardName) {
                    alert('Please fill in all card details');
                    return;
                }
                if (!validateCardNumber(cardNumber)) {
                    showError('card-number', 'Please enter a valid 16-digit card number');
                    return;
                }
                if (!validateExpiryDate(cardExpiry)) {
                    showError('card-expiry', 'Please enter a valid expiry date (MM/YY)');
                    return;
                }
                if (!validateCVV(cardCvv)) {
                    showError('card-cvv', 'Please enter a valid CVV');
                    return;
                }
                if (cardName.trim().length < 3) {
                    showError('card-name', 'Please enter a valid name');
                    return;
                }
            }
            continuePaymentProcess();
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.classList.add('card-input-error');
            const errorMessage = element.nextElementSibling;
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function clearErrors() {
            document.querySelectorAll('.card-input').forEach(input => {
                input.classList.remove('card-input-error');
                input.nextElementSibling.style.display = 'none';
            });
        }

       
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('.card-input');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    this.classList.remove('card-input-error');
                    this.nextElementSibling.style.display = 'none';
                });
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user) {
                alert('Please login first');
                window.location.href = 'login.html';
                return;
            }

           
            const savedTicket = JSON.parse(localStorage.getItem('selectedTicket'));
            if (savedTicket) {
                const select = document.getElementById('ticket-select');
                Array.from(select.options).forEach(option => {
                    if (option.value === savedTicket.type) {
                        option.selected = true;
                    }
                });
                updateTicketDetails();
            } else {
                window.location.href = 'tickets.html'; 
            }
        });

        function processPayment() {
            const user = JSON.parse(localStorage.getItem("user"));
            const ticketData = JSON.parse(localStorage.getItem("selectedTicket"));

         
            if (!selectedMethod) {
                alert("Please select a payment method");
                return;
            }

            
            fetch("http://localhost:3000/purchase-ticket", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    ...ticketData,
                    paymentMethod: selectedMethod
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Purchase successful!");
                    localStorage.removeItem('selectedTicket'); 
                    window.location.href = "index.html#active-tickets";
                } else {
                    alert("Purchase failed. Please try again.");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred during payment.");
            });
        }
    </script>

    <script>
        function processPayment() {
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user) {
                alert("Please login first!");
                window.location.href = "login.html";
                return;
            }

            const ticketData = JSON.parse(localStorage.getItem("selectedTicket"));
            
            fetch("http://localhost:3000/purchase-ticket", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    userId: user.id,
                    type: ticketData.type,
                    price: ticketData.price,
                    duration: ticketData.duration
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Purchase successful!");
                    localStorage.removeItem('selectedTicket'); 
                   
                    window.location.href = "index.html?refresh=true";
                } else {
                    alert("Purchase failed. Please try again.");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred during payment.");
            });
        }
    </script>

    <script>
function processPayment() {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) {
        alert("Please login first!");
        window.location.href = "login.html";
        return;
    }

    if (!document.querySelector('.payment-method.selected')) {
        alert('Please select a payment method');
        return;
    }

    if (selectedMethod === 'card') {
        const cardNumber = document.getElementById('card-number').value;
        const cardExpiry = document.getElementById('card-expiry').value;
        const cardCvv = document.getElementById('card-cvv').value;
        const cardName = document.getElementById('card-name').value;

        if (!cardNumber || !cardExpiry || !cardCvv || !cardName) {
            alert('Please fill in all card details');
            return;
        }

        if (!validateCardNumber(cardNumber)) {
            showError('card-number', 'Please enter a valid 16-digit card number');
            return;
        }
        if (!validateExpiryDate(cardExpiry)) {
            showError('card-expiry', 'Please enter a valid expiry date (MM/YY)');
            return;
        }
        if (!validateCVV(cardCvv)) {
            showError('card-cvv', 'Please enter a valid CVV');
            return;
        }
        if (cardName.trim().length < 3) {
            showError('card-name', 'Please enter a valid name');
            return;
        }
    }

    const ticketData = JSON.parse(localStorage.getItem("selectedTicket"));
    
    fetch("http://localhost:3000/purchase-ticket", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            userId: user.id,
            type: ticketData.type,
            price: ticketData.price,
            duration: ticketData.duration,
            paymentMethod: selectedMethod
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Purchase successful! Your ticket is now active.");
            localStorage.removeItem('selectedTicket');
            window.location.href = "index.html?refresh=true";
        } else {
            alert("Purchase failed. Please try again.");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("An error occurred during payment. Please try again.");
    });
}

function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.classList.add('card-input-error');
        const errorMessage = element.nextElementSibling;
        if (errorMessage) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        element.focus();
    }
}
</script>

<script>
function loadCurrentPrices() {
    fetch('http://localhost:3000/ticket-prices')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('ticket-select');
                select.innerHTML = ''; 
                
                data.prices.forEach(ticket => {
                    const option = document.createElement('option');
                    option.value = ticket.type;
                    option.dataset.price = ticket.price;
                    option.dataset.duration = ticket.duration;
                    option.textContent = `${ticket.type} - ${ticket.price} SAR`;
                    select.appendChild(option);
                });
                
                
                updateTicketDetails();
            }
        })
        .catch(error => {
            console.error('Error loading prices:', error);
          
        });
}

function updateTicketDetails() {
    const select = document.getElementById('ticket-select');
    const option = select.options[select.selectedIndex];
    
    const type = option.value;
    const price = option.dataset.price;
    const duration = option.dataset.duration;
    
    document.getElementById('ticket-type').textContent = type;
    document.getElementById('ticket-duration').textContent = duration;
    document.getElementById('ticket-price').textContent = price;
    document.getElementById('button-price').textContent = price;
    
    const ticketData = {
        type: type,
        price: parseFloat(price),
        duration: duration
    };
    localStorage.setItem('selectedTicket', JSON.stringify(ticketData));
}


document.addEventListener('DOMContentLoaded', function() {
    loadCurrentPrices();
});
</script>

<script>

document.addEventListener('DOMContentLoaded', function() {
    
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
        alert('Please login first');
        window.location.href = 'login.html';
        return;
    }

    
    const savedTicket = JSON.parse(localStorage.getItem('selectedTicket'));
    if (!savedTicket) {
        window.location.href = 'tickets.html';
        return;
    }

   
    document.getElementById('ticket-type').textContent = savedTicket.type;
    document.getElementById('ticket-duration').textContent = savedTicket.duration;
    document.getElementById('ticket-price').textContent = savedTicket.price.toFixed(2);
    document.getElementById('button-price').textContent = savedTicket.price.toFixed(2);

    
    fetch('http://localhost:3000/ticket-prices')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('ticket-select');
                select.innerHTML = '';
                
                data.prices.forEach(ticket => {
                    const option = document.createElement('option');
                    option.value = ticket.type;
                    option.dataset.price = ticket.price;
                    option.dataset.duration = ticket.duration;
                    option.textContent = `${ticket.type} - ${ticket.price} SAR`;
                    
                   
                    if (savedTicket.type === ticket.type) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading prices:', error);
           
            const select = document.getElementById('ticket-select');
            const option = document.createElement('option');
            option.value = savedTicket.type;
            option.dataset.price = savedTicket.price;
            option.dataset.duration = savedTicket.duration;
            option.textContent = `${savedTicket.type} - ${savedTicket.price} SAR`;
            option.selected = true;
            select.appendChild(option);
        });
});


function updateTicketDetails() {
    const select = document.getElementById('ticket-select');
    const option = select.options[select.selectedIndex];
    
    if (option) {
        const type = option.value;
        const price = parseFloat(option.dataset.price);
        const duration = option.dataset.duration;
        
        document.getElementById('ticket-type').textContent = type;
        document.getElementById('ticket-duration').textContent = duration;
        document.getElementById('ticket-price').textContent = price.toFixed(2);
        document.getElementById('button-price').textContent = price.toFixed(2);
        
        const ticketData = {
            type: type,
            price: price,
            duration: duration,
            selectedTime: new Date().toISOString()
        };
        localStorage.setItem('selectedTicket', JSON.stringify(ticketData));
    }
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
        alert('Please login first');
        window.location.href = 'login.html';
        return;
    }

    
    const savedTicket = JSON.parse(localStorage.getItem('selectedTicket'));
    if (!savedTicket) {
        window.location.href = 'tickets.html';
        return;
    }

   
    displayTicketDetails(savedTicket);
    
    
    loadAvailableTickets(savedTicket);
});

function displayTicketDetails(ticket) {
    document.getElementById('ticket-type').textContent = ticket.type;
    document.getElementById('ticket-duration').textContent = ticket.duration;
    document.getElementById('ticket-price').textContent = ticket.price.toFixed(2);
    document.getElementById('button-price').textContent = ticket.price.toFixed(2);
}

function loadAvailableTickets(selectedTicket) {
    fetch('http://localhost:3000/ticket-prices')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('ticket-select');
                select.innerHTML = '';
                
                data.prices.forEach(ticket => {
                    const option = document.createElement('option');
                    option.value = ticket.type;
                    option.dataset.price = ticket.price;
                    option.dataset.duration = ticket.duration;
                    option.textContent = `${ticket.type} - ${ticket.price} SAR`;
                    
                    if (selectedTicket.type === ticket.type) {
                        option.selected = true;
                    }
                    
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading tickets:', error);
            
            const select = document.getElementById('ticket-select');
            const option = document.createElement('option');
            option.value = selectedTicket.type;
            option.dataset.price = selectedTicket.price;
            option.dataset.duration = selectedTicket.duration;
            option.textContent = `${selectedTicket.type} - ${selectedTicket.price} SAR`;
            option.selected = true;
            select.appendChild(option);
        });
}

function updateTicketDetails() {
    const select = document.getElementById('ticket-select');
    const option = select.options[select.selectedIndex];
    
    if (option) {
        const ticketData = {
            type: option.value,
            price: parseFloat(option.dataset.price),
            duration: option.dataset.duration,
            selectedTime: new Date().toISOString()
        };
        
        localStorage.setItem('selectedTicket', JSON.stringify(ticketData));
        displayTicketDetails(ticketData);
    }
}
</script>

<script>

document.addEventListener('DOMContentLoaded', function() {
    
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
        alert('Please login first');
        window.location.href = 'login.html';
        return;
    }

    
    const savedTicket = JSON.parse(localStorage.getItem('selectedTicket'));
    if (!savedTicket || !savedTicket.type) {
        alert('Please select a ticket first');
        window.location.href = 'tickets.html';
        return;
    }

   
    document.getElementById('ticket-type').textContent = savedTicket.type;
    document.getElementById('ticket-duration').textContent = savedTicket.duration;
    document.getElementById('ticket-price').textContent = savedTicket.price.toFixed(2);
    document.getElementById('button-price').textContent = savedTicket.price.toFixed(2);

    const select = document.getElementById('ticket-select');
    const option = document.createElement('option');
    option.value = savedTicket.type;
    option.dataset.price = savedTicket.price;
    option.dataset.duration = savedTicket.duration;
    option.textContent = `${savedTicket.type} - ${savedTicket.price} SAR`;
    option.selected = true;
    select.innerHTML = ''; 
    select.appendChild(option);
});


function updateTicketDetails() {
    const savedTicket = JSON.parse(localStorage.getItem('selectedTicket'));
    if (savedTicket) {
        document.getElementById('ticket-type').textContent = savedTicket.type;
        document.getElementById('ticket-duration').textContent = savedTicket.duration;
        document.getElementById('ticket-price').textContent = savedTicket.price.toFixed(2);
        document.getElementById('button-price').textContent = savedTicket.price.toFixed(2);
    }
}

</script>

<script>
function updateTicketDetails() {
    const select = document.getElementById('ticket-select');
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption) {
        const type = selectedOption.value;
        const price = parseFloat(selectedOption.dataset.price);
        const duration = selectedOption.dataset.duration;
        
        
        document.getElementById('ticket-type').textContent = type;
        document.getElementById('ticket-duration').textContent = duration;
        document.getElementById('ticket-price').textContent = price.toFixed(2);
        document.getElementById('button-price').textContent = price.toFixed(2);
        
       
        const ticketData = {
            type: type,
            price: price,
            duration: duration,
            selectedTime: new Date().toISOString()
        };
        localStorage.setItem('selectedTicket', JSON.stringify(ticketData));
    }
}


document.addEventListener('DOMContentLoaded', function() {
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
        alert('Please login first');
        window.location.href = 'login.html';
        return;
    }

    const savedTicket = JSON.parse(localStorage.getItem('selectedTicket'));
    if (!savedTicket) {
        window.location.href = 'tickets.html';
        return;
    }

    
    fetch('http://localhost:3000/ticket-prices')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('ticket-select');
                select.innerHTML = '';
                
                data.prices.forEach(ticket => {
                    const option = document.createElement('option');
                    option.value = ticket.type;
                    option.dataset.price = ticket.price;
                    option.dataset.duration = ticket.duration;
                    option.textContent = `${ticket.type} - ${ticket.price} SAR`;
                    
                    if (savedTicket && savedTicket.type === ticket.type) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                
                updateTicketDetails();
            }
        })
        .catch(error => {
            console.error('Error loading tickets:', error);
        });

   
    const select = document.getElementById('ticket-select');
    select.addEventListener('change', updateTicketDetails);
});
</script>

    <footer>
       
        <div id="tail">
            <div id="third">
                <p>Download darb app now!</p>
                <div>
                    <a href="https://apps.apple.com/sa/app/darb-%D8%AF%D8%B1%D8%A8/id1549817739">
                        <img src="Pics/as.png" id="pi">
                    </a>
                    <a href="https://play.google.com/store/apps/details?id=com.rcrc.riyadhjourneyplanner">
                        <img src="Pics/gp.png" id="pi">
                    </a>
                </div>
            </div>
            <div id="second">
                <div id="t3"> 
                    <a href="line.html"><button class="buttons2">Metro lines</button></a>
                    <a href="Paths.html"><button class="buttons2">Plan your journey</button></a>
                    <a href="tickets.html"><button class="buttons2">Buy a ticket</button></a>
                </div>
                <div id="t3">
                    <a href="About.html"><button class="buttons2">About the metro</button></a>
                    <a href="Contact.html"><button class="buttons2">Contact us</button></a>
                </div>
            </div>
            <div id="first">
                <div id="t1"><img src="Pics/drb.png" id="drb"></div>
                <div id="t2">
                    <a href="https://www.youtube.com/channel/UCQYmsh8gxjU5HM7gEyRkT5w">
                        <img src="Pics/youtube.png" id="sm">
                    </a>
                    <a href="https://www.linkedin.com/company/riyadhtransport/">
                        <img src="Pics/linkedin.png" id="sm">
                    </a>
                    <a href="https://www.facebook.com/riyadhtransport">
                        <img src="Pics/facebook.png" id="sm">
                    </a>
                    <a href="https://www.instagram.com/riyadhtransport/">
                        <img src="Pics/instagram.png" id="sm">
                    </a>
                    <a href="https://x.com/RiyadhTransport">
                        <img src="Pics/twitter.png" id="sm">
                    </a>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>
